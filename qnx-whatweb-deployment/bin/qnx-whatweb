#!/bin/bash
#
# QNX WhatWeb - Web Technology Fingerprinting Tool
# Binary launcher for BlackBerry QNX 8 ARM
#

# Script directory detection
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
WHATWEB_SCRIPT="$LIB_DIR/qnx_whatweb.py"

echo "QNX WhatWeb - Web Technology Fingerprinting Tool v1.0"
echo "======================================================="

# Function to check Python version
check_python() {
    local python_cmd="$1"
    
    if ! command -v "$python_cmd" >/dev/null 2>&1; then
        return 1
    fi
    
    # Get Python version
    local version_output
    version_output="$($python_cmd --version 2>&1)"
    
    # Extract version numbers
    local version
    version=$(echo "$version_output" | grep -o '[0-9]\+\.[0-9]\+' | head -1)
    
    if [ -z "$version" ]; then
        return 1
    fi
    
    # Check if version is 3.11 or higher (simplified check)
    local major minor
    IFS='.' read -r major minor <<< "$version"
    
    if [ "$major" -ge 3 ] && [ "$minor" -ge 11 ]; then
        echo "$python_cmd"
        return 0
    fi
    
    return 1
}

# Main execution
case "${1:-}" in
    --check|--test)
        echo "Checking installation..."
        if [ ! -f "$WHATWEB_SCRIPT" ]; then
            echo "ERROR: QNX WhatWeb script not found"
            exit 1
        fi
        
        for cmd in python3.11 python3 python; do
            if check_python "$cmd" >/dev/null 2>&1; then
                local version
                version="$($cmd --version 2>&1)"
                echo "Found Python: $version"
                echo "QNX WhatWeb is ready to use!"
                exit 0
            fi
        done
        
        echo "ERROR: Python 3.11+ required but not found"
        echo "Download from: berrystore.sw7ft.com"
        exit 1
        ;;
    "")
        echo "Usage: qnx-whatweb [options] <URLs>"
        echo "Run 'qnx-whatweb --help' for detailed help"
        exit 0
        ;;
esac

# Find Python and execute
for cmd in python3.11 python3 python; do
    if PYTHON_CMD=$(check_python "$cmd" 2>/dev/null); then
        exec "$PYTHON_CMD" "$WHATWEB_SCRIPT" "$@"
    fi
done

echo "ERROR: Python 3.11+ required. Run 'qnx-whatweb --check' for details."
exit 1
